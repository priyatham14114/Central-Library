sap.ui.define(["./baseController","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/json/JSONModel"],function(e,t,o,i,a,n,s){"use strict";return e.extend("com.app.centrallibrary.controller.adminView",{onInit:function(){a.show("Welcome to the Central Library");const e=new n({authorName:"",title:"",quantity:"",availableQuantity:"",ISBN:""});const o=new n({borrowerName:"",borrowerUserId:"",borrowingBookName:"",borrowingBookISBN:"",dueOn:""});this.getView().setModel(e,"newBookModel");this.getView().setModel(o,"newLoanModel");const i=this.getView();const s=i.byId("idAuthorInputValue"),r=i.byId("idTitleInputValue");const l=[s,r];l.forEach(e=>{e.addValidator(function(e){if(true){var o=e.text;return new t({key:o,text:o})}})});const u=this.getOwnerComponent().getRouter();u.attachRoutePatternMatched(this.onCurrentUserDetails,this)},onCurrentUserDetails:function(e){const{userId:t}=e.getParameter("arguments");this.ID=t;const o=e.getParameter("name");const i=this.getView().byId("idAdminDataPage");i.bindElement(`/UserLogin(${t})`,{expand:""})},onLogoutPress:function(){const e=this.getOwnerComponent().getRouter();a.show("Successfully Logged Out");e.navTo("RouteloginView",{},true)},onFilterClick:function(){debugger;const e=this.getView(),t=e.byId("idAuthorInputValue").getTokens(),a=e.byId("idTitleInputValue").getTokens(),n=e.byId("idBooksTable"),s=[];var r=[t,a];r.forEach(e=>{if(e){e.filter(e=>{t.length>0?s.push(new o("authorName",i.EQ,e.getKey())):"";a.length>0?s.push(new o("title",i.EQ,e.getKey())):""})}});n.getBinding("items").filter(s)},onClear:function(){const e=this.getView(),t=e.byId("idAuthorInputValue").destroyTokens(),o=e.byId("idTitleInputValue").destroyTokens()},onRefresh:function(){this.getView().byId("idBooksTable").getBinding("items").refresh()},onEditBook:async function(){debugger;debugger;if(!this.oCreateBookPop){this.oCreateBookPop=await this.loadFragment("createBook")}var e=this.byId("idBooksTable").getSelectedItem();if(e){var t=e.getBindingContext().getObject().authorName;var o=e.getBindingContext().getObject().title;var i=e.getBindingContext().getObject().quantity;var s=e.getBindingContext().getObject().availableQuantity;var r=e.getBindingContext().getObject().ISBN;const a=new n({authorName:t,title:o,quantity:i,availableQuantity:s,ISBN:r});this.getView().setModel(a,"newBookModel");this.oCreateBookPop.open()}else{a.show("Select an Item to Edit")}},onCreateBtnPress:async function(){debugger;if(!this.oCreateBookPop){this.oCreateBookPop=await this.loadFragment("createBook")}this.oCreateBookPop.open()},onUpdateBook:function(){debugger;var e=this.getView().getModel("newBookModel").getData();var t=this.getView().byId("idBooksTable");var n=t.getSelectedItem();var s=n.getBindingContext().getObject().title;var r=this.getView().getModel();var l=r.bindList("/Books");l.filter([new o("title",i.EQ,s)]);var u=this;l.requestContexts().then(function(o){if(o.length>0){var i=o[0];var n=i.getObject();i.setProperty("title",e.title);i.setProperty("authorName",e.authorName);i.setProperty("quantity",e.quantity);i.setProperty("availableQuantity",e.availableQuantity);i.setProperty("ISBN",e.ISBN);const s=parseInt(e.availableQuantity);const l=parseInt(e.quantity);if(s<=l){r.submitBatch("updateGroup").then(function(){t.getBinding("items").refresh();u.getView().byId("idAuthorName").setValue("");u.getView().byId("idbookNameInput").setValue("");u.getView().byId("idStockInput").setValue("");u.getView().byId("idavailableQuantityInput").setValue("");u.getView().byId("idbooks_ISBNInput").setValue("");u.oCreateBookPop.close();a.show("Book Updated Successfully")}).catch(function(e){u.oCreateBookPop.close();sap.m.MessageBox.error("Failed to update book: "+e.message)})}else{a.show("Avilable Stock should be lesser or equal to the Stock")}}else{a.show("Book not found")}})},onCreateBook:function(){debugger;var e=this.getView();var t=this.getView().getModel(),o=t.bindList("/Books");var i=this.getView().getModel("newBookModel").getData();var n=i.availableQuantity;var s=i.quantity;if(s>=n){o.create(i,{success:a.show("Book created successfully"),refresh:e.byId("idBooksTable").getBinding("items").refresh(),error:function(){a.show("Error creating book")}});e.byId("idAuthorName").setValue("");e.byId("idbookNameInput").setValue("");e.byId("idStockInput").setValue("");e.byId("idavailableQuantityInput").setValue("");e.byId("idbooks_ISBNInput").setValue("");this.oCreateBookPop.close()}else{a.show("Avilable Stock should be lesser or equal to the Stock")}},onCloseCreateBookDailog:function(){if(this.oCreateBookPop.isOpen()){this.oCreateBookPop.close()}},onDeleteBooks:async function(){if(!this.oConfirmBookDel){this.oConfirmBookDel=await this.loadFragment("confirmDeleteBook")}this.oConfirmBookDel.open()},onConfirmDeleteButtonPress:function(){debugger;var e=this;var t=this.byId("idBooksTable").getSelectedItems();if(t){var o=[];t.forEach(function(e){var t=e.getBindingContext();o.push(t)});o.forEach(function(t){var o=t.getObject().availableQuantity;var i=t.getObject().quantity;if(o===i){t.delete("$auto");a.show("Book Deleted");e.oConfirmBookDel.close()}else{a.show("You can not delete the issued book")}})}else{a.show("Please Select a Book to Delete")}},onCloseIssueBookButton:function(){if(this.oConfirmBookDel.isOpen()){this.oConfirmBookDel.close()}},onActiveLoansClick:async function(){debugger;if(!this.oActiveLoanPopUp){this.oActiveLoanPopUp=await this.loadFragment("ActiveLoans")}this.oActiveLoanPopUp.open();this.getView().byId("idLoanTable").getBinding("items").refresh()},onCloseActiveLoans:function(){if(this.oActiveLoanPopUp.isOpen()){this.oActiveLoanPopUp.close()}},onReservationsClick:async function(){debugger;if(!this.oReservationsDialog){this.oReservationsDialog=await this.loadFragment("Reservations")}this.getView().byId("idReservationsTable").getBinding("items").refresh();this.oReservationsDialog.open()},onIssueBookFromReservations:function(){debugger;const e=this.getView(),t=e.byId("idReservationsTable").getSelectedItem();if(!t){a.show("Please select a reservation to issue the book")}const n=t.getBindingContext(),s=t.getBindingContext().getObject().ReservedUserName,r=t.getBindingContext().getObject().ReservedUserId,l=t.getBindingContext().getObject().ReservedBook;let u=new Date;u.setDate(u.getDate()+15);var g=u.getFullYear();var d=u.getMonth()+1;var c=u.getDate();var h=`${g}-${d}-${c}`;const b=this.getView().getModel(),w=this.getView().byId("idBooksTable");var v=b.bindList("/Books");v.filter([new o("title",i.EQ,l)]);v.requestContexts().then(function(e){if(e.length>0){var t=e[0];var o=t.getObject();if(o.availableQuantity>0){const e=b.bindList("/Activeloans");e.create({borrowerName:s,borrowerUserId:r,borrowingBookName:l,dueOn:h});n.delete("$auto").then(function(){a.show("Book Issued")});o.availableQuantity-=1;t.setProperty("availableQuantity",o.availableQuantity);b.submitBatch("updateGroup")}else{a.show("Book not available yet")}}else{a.show("Book not available to issue")}})},onReservationsClose:function(){if(this.oReservationsDialog.isOpen()){this.oReservationsDialog.close()}},onAddNewLoanPress:async function(){debugger;let e=new Date;e.setDate(e.getDate()+15);var t=e.getFullYear();var o=e.getMonth()+1;var i=e.getDate();var a=`${t}-${o}-${i}`;if(!this.oNewLoanDailog){this.oNewLoanDailog=await this.loadFragment("loanCreate");const e=new n({borrowerName:"",borrowerUserId:"",borrowingBookName:"",borrowingBookISBN:"",dueOn:a});this.getView().setModel(e,"newLoanModel")}this.oNewLoanDailog.open()},onNewLoanDailogClose:function(){if(this.oNewLoanDailog.isOpen()){this.oNewLoanDailog.close()}},onDateChange:function(e){var t=e.getSource();var o=t.getValue();var i=/^\d{4}-\d{2}-\d{2}$/;if(o.match(i)){var n=new Date(o);var s=new Date;s.setHours(0,0,0,0);if(n>=s){t.setValueState("None");a.show("Date is valid")}else{t.setValueState("Error");a.show("Date cannot be in the past date.")}}else{t.setValueState("Error");a.show("Invalid date format. Please use YYYY-MM-DD.")}},onSaveNewLoan:function(){try{debugger;var e=this.getView().getModel(),t=e.bindList("/Activeloans");var n=this.getView().getModel("newLoanModel").getData();var s=n.borrowerUserId;var r=n.borrowerName;var l=n.borrowingBookISBN;var u=n.borrowingBookName;var g=this;if(s){var e=this.getView().getModel();var d=e.bindList("/UserLogin");d.filter([new o("userid",i.EQ,s),new o("userName",i.EQ,r)]);d.requestContexts().then(function(s){debugger;if(s.length>0){var r=e.bindList("/Books");r.filter([new o("title",i.EQ,u),new o("ISBN",i.EQ,l)]);r.requestContexts().then(function(o){if(o.length>0){var i=o[0];var s=i.getObject();if(s.availableQuantity>0){s.availableQuantity-=1;t.create(n);i.setProperty("availableQuantity",s.availableQuantity);e.submitBatch("updateGroup").then(function(){g.oNewLoanDailog.close();a.show("Book issued")})}else{a.show("Book not available")}}else{a.show("Book data not found")}})}else{a.show("User data not matching with existing records")}})}else{a.show("Enter correct user Data to Continue")}}catch(e){a.show(e)}},onClearLoan:async function(){debugger;if(!this.oDeleteCautionDailog){this.oDeleteCautionDailog=await this.loadFragment("confirmDelete")}this.oDeleteCautionDailog.open()},oDeleteCautionDailogClose:function(){if(this.oDeleteCautionDailog.isOpen()){this.oDeleteCautionDailog.close()}},onClearLoanButtonPress:function(){debugger;const e=this.getView(),t=e.byId("idLoanTable").getSelectedItem();if(t){var n=t.getBindingContext(),s=n.getObject(),r=s.borrowingBookName,l=this.getView().getModel(),u=s.borrowerName;n.delete("$auto").then(function(){a.show(u+" Loan Closed");var e=l.bindList("/Books");e.filter([new o("title",i.EQ,r)]);e.requestContexts().then(function(e){if(e.length>0){var t=e[0];var o=t.getObject();var i=o.availableQuantity;var n=parseInt(i);var s=n+1;t.setProperty("availableQuantity",s);l.submitBatch("updateGroup",{success:function(){a.show("Book quantity updated successfully")},error:function(e){a.show("Error updating book quantity: "+e.message)}})}else{a.show("Book not found")}})},function(e){a.show("Deletion Error: "+e.message)});this.getView().byId("idLoanTable").getBinding("items").refresh()}else{a.show("Please Select a user to close the loan")}this.oDeleteCautionDailog.close()}})});